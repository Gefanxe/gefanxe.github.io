<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>量詞練習遊戲｜無限隨機・觸碰作答（50題＋注音）</title>
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://gefanxe.github.io/mabau-game-1.html" />
  <meta property="og:title" content="量詞練習遊戲｜無限隨機・觸碰作答（50題＋注音）" />
  <meta property="og:description" content="專為6歲孩童設計的中文量詞練習遊戲，50個精心設計的題目，每題都附有注音，幫助學習發音。互動式學習，讓孩子在遊戲中快樂學習量詞！" />
  <meta property="og:image" content="https://gefanxe.github.io/images/preview.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://gefanxe.github.io/mabau-game-1.html" />
  <meta name="twitter:title" content="量詞練習遊戲｜無限隨機・觸碰作答（50題＋注音）" />
  <meta name="twitter:description" content="專為6歲孩童設計的中文量詞練習遊戲，50個精心設計的題目，每題都附有注音，幫助學習發音。互動式學習，讓孩子在遊戲中快樂學習量詞！" />
  <meta name="twitter:image" content="https://gefanxe.github.io/images/preview.png" />
  
  <!-- 一般 meta 標籤 -->
  <meta name="description" content="專為6歲孩童設計的中文量詞練習遊戲，50個精心設計的題目，每題都附有注音，幫助學習發音。互動式學習，讓孩子在遊戲中快樂學習量詞！" />
  <meta name="keywords" content="量詞,中文學習,兒童教育,注音符號,語言學習,教育遊戲" />
  <link type="text/css" rel="stylesheet" href="./assets/phon.css" charset="utf8">
  <style>
    /* -----------------------------------------------------------
       內嵌 Bootswatch：Yeti 風格（節錄並微調）
       說明：依規則從 bootswatch 主題中隨機挑選並整合於 <style>。
       著重色彩、按鈕、卡片、陰影、排版（已調整為暖色系）。
    ------------------------------------------------------------*/
    :root{
      --primary:#ff7043;     /* 主色：活潑橘 */
      --primary-dark:#f4511e;
      --bg:#fff3e0;          /* 背景：淺橙 */
      --text:#4e342e;        /* 文字：深棕 */
      --card:#ffffff;        /* 卡片底色 */
      --good:#2e7d32;        /* 正解：綠 */
      --bad:#c62828;         /* 誤答：紅 */
      --muted:#6d4c41;       /* 次要文字 */
    }

    /* 全域排版與 RWD */
    html,body{height:100%;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
      padding:24px 24px 48px 24px;
      min-height:100vh;
      min-height:100dvh; /* 動態視窗高度，適配 iPhone 底部工具列 */
      /* 針對 iPhone Safari 的安全區域調整 */
      padding-bottom:max(48px, env(safe-area-inset-bottom));
    }

    /* 容器卡片：採卡片+陰影風格 */
    .app{
      width:min(960px,100%);
      background:var(--card);
      border-radius:24px;
      box-shadow:0 20px 40px rgba(0,0,0,0.08);
      padding:clamp(16px,3vw,28px);
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 96px);
      min-height: calc(100dvh - 96px); /* 動態視窗高度 */
      max-height: calc(100vh - 96px);
      max-height: calc(100dvh - 96px); /* 確保不超過視窗高度 */
      overflow-y: auto; /* 如有需要可滾動 */
    }

    /* 標題列：emoji + Bootstrap Icons 風格（以emoji替代） */
    .header{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }

    /* 標題左側區域 */
    .title-section{
      width: 100%;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:clamp(20px,3.2vw,28px);
      font-weight:800;
      color:var(--primary-dark);
    }

    /* 標題區域的切換按鈕 */
    .title-controls{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .title-btn{
      font-size:14px;
      border:none;
      background: #ffe0b2;
      color:#6d4c41;
      font-weight:600;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
      box-shadow:0 4px 8px rgba(244,81,30,.25);
      transition:background .2s ease, transform .06s ease;
      touch-action:manipulation;
      white-space:nowrap;
    }
    .title-btn:hover{ background:#ffd08a; }
    .title-btn:active{ transform:translateY(1px); }
    .title-btn.active{ background:var(--primary); color:#fff; }
    .title-btn.active:hover{ background:var(--primary-dark); }


    .scoreboard{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:clamp(16px,2.4vw,20px);
      color:var(--muted);
    }
    .badge{
      background:var(--primary);
      color:#fff;
      padding:6px 12px;
      border-radius:999px;
      font-weight:700;
      box-shadow:0 6px 16px rgba(244,81,30,.25);
    }

    /* 題目卡 */
    .card{
      background:#fff;
      border:1px solid #ffe0b2;
      border-radius:20px;
      padding:clamp(14px,3vw,24px);
      /* margin-top:8px; */
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .prompt{
      display: flex;
      justify-content: center;
      align-content: center;
      gap:10px;
      /* margin: 0 auto; */
    }

    /* 初始隱藏提示區塊 */
    .prompt.hidden {
      display: none;
    }

    .emoji{
      font-size:clamp(70px,8vw,80px);
      vertical-align: super;
    }
    #noun {
      display: flex;
      justify-content: space-evenly;
    }
    /* .noun{
      font-family: BopomofoRuby, 'AR KaiB5', 'KaiTi TW', '標楷體';
      font-size:clamp(34px,3vw,38px);
      color:#5d4037;
      writing-mode: vertical-rl;
      -webkit-writing-mode: vertical-rl;
      -moz-writing-mode: vertical-rl;
      text-orientation: upright;
    } */

    .ansBtn {
      color:#fff
    }

    .ansBtn [data-after]::after {
      color:#fff
    }

    /* ruby {
      ruby-position: under;
      margin: 16px 0;
    } */

    /* ruby rb{ } */

    /* ruby rt{
      color:#8d6e63;
      margin-left: 4px;
    }

    ruby.ans rb{
      font-size: 1.3em;
    }

    ruby.ans rt{
      font-size:.7em;
      color:#ffffff;
      margin-top: 5px;
    } */

    .ansScope {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: end;
    }


    /* 選項區：2欄 RWD，平板以上 4 欄 */
    .options{
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      /* margin-top:16px; */
      /* display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap: 5px;
      flex: 1;
      align-content: stretch; */
    }
    /* @media (min-width:720px){
      .options{ 
        grid-template-columns:repeat(4, minmax(0,1fr)); 
        align-content: end;
      }
    } */

    /* 選項按鈕 */
    .opt{
      width: 120px;
      height: 80px;
      border:none;
      border-radius:16px;
      font-size:clamp(24px,2.4vw,28px);
      font-weight:600;
      background:var(--primary);
      color:#fff;
      cursor:pointer;
      box-shadow:0 10px 20px rgba(255,112,67,.28);
      transition:transform .06s ease, background .2s ease, box-shadow .2s ease;
      touch-action:manipulation;
    }
    .opt:hover{ background:var(--primary-dark); }
    .opt:active{ transform:translateY(1px); }

    /* PC 螢幕尺寸時限制按鈕最大尺寸 */
    /* @media (min-width:720px){
      .opt{
        max-width: 200px;
        max-height: 80px;
        margin: 0 auto;
      }
    } */

    /* 作答後狀態 */
    .opt.correct{ background:var(--good); box-shadow:0 10px 20px rgba(46,125,50,.28); }
    .opt.wrong{ background:var(--bad); box-shadow:0 10px 20px rgba(198,40,40,.28); }

    /* 控制列 */
    .controls{
      margin-top: 5px;
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      justify-content:space-evenly;
    }

    #startBtn {
      /* height: 100px; */
      font-size: x-large;
    }

    .btn{
      font-size:larger;
      border:none;
      background:#ffe0b2;
      color:#6d4c41;
      font-weight:500;
      padding:10px 16px;
      border-radius:12px;
      cursor:pointer;
      box-shadow:0 6px 12px rgba(0,0,0,.06);
      transition:background .2s ease, transform .06s ease;
      touch-action:manipulation;
    }
    .btn:hover{ background:#ffd08a; }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ background:var(--primary); color:#fff; }
    .btn.primary:hover{ background:var(--primary-dark); }

    /* 按鈕隱藏樣式 */
    .btn.hidden {
      display: none;
    }
    
    .title-btn.hidden {
      display: none;
    }

    /* 隱藏 emoji 和注音的樣式 */
    .emoji.hidden-content {
      visibility: hidden;
    }
    
    ruby rt.hidden-content {
      display: none;
    }

    /* 回饋訊息 */
    .feedback{
      /* height: 71px; */
      min-height:1.8em;
      text-align:center;
      margin-bottom: 16px;
      font-size:clamp(18px,2.6vw,22px);
      font-weight:800;
    }
    .feedback.ok{ color:var(--good); }
    .feedback.no{ color:var(--bad); }

    /* 規則6：避免輸入元件溢出容器 */
    *{ box-sizing:border-box; }
    input, select, textarea{ max-width:100%; }

    /* Footer 樣式 */
    .footer{
      padding-top: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--muted);
      font-size: 16px;
      position: relative;
      margin-top: auto;
    }
    .footer-center{
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .footer img{
      width: 32px;
      height: 32px;
      object-fit: contain;
    }
    .footer-text{
      font-weight: 600;
      color: var(--text);
    }
    .footer-year{
      position: absolute;
      right: 0;
      font-weight: 600;
      color: #ffb74c;
    }

    /* 鼓勵文字區塊 */
    .welcome-message {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: clamp(18px, 3vw, 22px);
      line-height: 1.6;
      margin: 20px 0;
    }

    .welcome-message h2 {
      color: var(--primary-dark);
      font-size: clamp(24px, 4vw, 32px);
      margin-bottom: 20px;
      font-weight: 500;
    }

    .welcome-message p {
      margin: 16px 0;
      font-weight: 600;
    }

    .welcome-message.hidden {
      display: none;
    }
  </style>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DKDD5CFQ4C"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-DKDD5CFQ4C');
  </script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DKDD5CFQ4C"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-DKDD5CFQ4C');
  </script>
</head>
<body>
  <main class="app">
    <!-- 標題＋分數板 -->
    <div class="header">
      <div class="title-section">
        <div class="title">🎯 量詞練習遊戲</div>
        <div class="title-controls">
          <button id="toggleEmojiBtn" class="title-btn hidden">圖</button>
          <button id="toggleZyBtn" class="title-btn hidden">注</button>
        </div>
      </div>
      <div class="scoreboard">
        📊 分數 <span id="score" class="badge">0</span>
        ✅ 連續答對 <span id="streak" class="badge" style="background:#66bb6a;box-shadow:0 6px 16px rgba(102,187,106,.25)">0</span>
      </div>
    </div>

    <!-- 題目卡 -->
    <section class="card">
      <!-- 歡迎訊息 -->
      <div id="welcomeMessage" class="welcome-message">
        <h2 id="encourageText"></h2>
      </div>

      <div class="prompt hidden">
        <span id="emoji" class="emoji">🍎</span>
        <!-- <span id="noun" class="noun"> -->
        <span class="dummy2 tb v after">
          <div id="noun">
            <!-- 以 ruby 顯示：中文字 + 注音 -->

          </div>
        </span>
      </div>

      <div class="ansScope" >
        <!-- 回饋 -->
        <div id="feedback" class="feedback"></div>
        
        <!-- 選項按鈕（量詞＋注音） -->
        <div id="options" class="options"></div>
        
        <div style="height: 1.5em;"></div>
  
        <!-- 控制列 -->
        <div class="controls">
          <button id="startBtn" class="btn primary">▶️ 開始練習</button>
          <button id="nextBtn" class="btn hidden">下一題</button>
          <button id="resetBtn" class="btn hidden">重新開始</button>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-center">
        <img src="./images/Facebook_Logo_Primary.png" alt="Facebook Logo">
        <span class="footer-text">小于媽ㄟ用芯生活</span>
      </div>
      <div class="footer-year">2025.09</div>
    </footer>
  </main>

  <script>
    /* -----------------------------------------------------------
      關鍵說明（註解）：
      1) 資料結構：每題含「emoji、題目中文字、題目注音、正確量詞、量詞注音」。
      2) 出題：隨機抽題並生成 4 個量詞選項（含正解 + 3 個干擾）。
      3) 互動：觸碰按鈕即作答；立即顯示正誤並上色，播放音效。
      4) RWD：按鈕網格會隨螢幕寬度切換 2~4 欄。
      5) 無限模式：不結束；可按「下一題」或答題完自動切換（1.2秒）。
    ------------------------------------------------------------*/

    // 量詞清單（提供隨機干擾用）
    const MEASURES = [
      {han:"顆",zy:"ㄎㄜ"}, {han:"隻",zy:"ㄓ"}, {han:"本",zy:"ㄅㄣˇ"}, {han:"支",zy:"ㄓ"},
      {han:"把",zy:"ㄅㄚˇ"}, {han:"張",zy:"ㄓㄤ"}, {han:"輛",zy:"ㄌㄧㄤˋ"}, {han:"台",zy:"ㄊㄞˊ"},
      {han:"部",zy:"ㄅㄨˋ"}, {han:"個",zy:"ㄍㄜˋ"}, {han:"封",zy:"ㄈㄥ"}, {han:"雙",zy:"ㄕㄨㄤ"},
      {han:"條",zy:"ㄊㄧㄠˊ"}, {han:"件",zy:"ㄐㄧㄢˋ"}, {han:"頂",zy:"ㄉㄧㄥˇ"}, {han:"副",zy:"ㄈㄨˋ"},
      {han:"朵",zy:"ㄉㄨㄛˇ"}, {han:"棵",zy:"ㄎㄜ"}, {han:"座",zy:"ㄗㄨㄛˋ"}, {han:"棟",zy:"ㄉㄨㄥˋ"},
      {han:"輪",zy:"ㄌㄨㄣˊ"}, {han:"扇",zy:"ㄕㄢˋ"}
    ];

    // 題庫 50 題（題目＋正確量詞，全含注音）
    const DATA = [
      {emo:"🍎", n:["蘋","果"], nz:["ㄆㄧㄥˊ","ㄍㄨㄛˇ"], m:"顆", mz:"ㄎㄜ"},
      {emo:"🐶", n:["狗"], nz:["ㄍㄡˇ"], m:"隻", mz:"ㄓ"},
      {emo:"🐱", n:["貓"], nz:["ㄇㄠ"], m:"隻", mz:"ㄓ"},
      {emo:"🐟", n:["魚"], nz:["ㄩˊ"], m:"條", mz:"ㄊㄧㄠˊ"},
      {emo:"🐦", n:["鳥"], nz:["ㄋㄧㄠˇ"], m:"隻", mz:"ㄓ"},
      {emo:"📖", n:["書"], nz:["ㄕㄨ"], m:"本", mz:"ㄅㄣˇ"},
      {emo:"🖊️", n:["筆"], nz:["ㄅㄧˇ"], m:"支", mz:"ㄓ"},
      {emo:"☂️", n:["雨","傘"], nz:["ㄩˇ","ㄙㄢˇ"], m:"把", mz:"ㄅㄚˇ"},
      {emo:"🪑", n:["椅","子"], nz:["ㄧˇ","ㄗ˙"], m:"張", mz:"ㄓㄤ"},
      {emo:"🚗", n:["車"], nz:["ㄔㄜ"], m:"輛", mz:"ㄌㄧㄤˋ"},
      {emo:"🚲", n:["單","車"], nz:["ㄉㄢ","ㄔㄜ"], m:"台", mz:"ㄊㄞˊ"},
      {emo:"🖥️", n:["電","腦"], nz:["ㄉㄧㄢˋ","ㄋㄠˇ"], m:"台", mz:"ㄊㄞˊ"},
      {emo:"📱", n:["手","機"], nz:["ㄕㄡˇ","ㄐㄧ"], m:"部", mz:"ㄅㄨˋ"},
      {emo:"📺", n:["電","視"], nz:["ㄉㄧㄢˋ","ㄕˋ"], m:"部", mz:"ㄅㄨˋ"},
      {emo:"🥤", n:["杯","子"], nz:["ㄅㄟ","ㄗ˙"], m:"個", mz:"ㄍㄜˋ"},
      {emo:"✉️", n:["信"], nz:["ㄒㄧㄣˋ"], m:"封", mz:"ㄈㄥ"},
      {emo:"👟", n:["鞋","子"], nz:["ㄒㄧㄝˊ","ㄗ˙"], m:"雙", mz:"ㄕㄨㄤ"},
      {emo:"🥢", n:["筷","子"], nz:["ㄎㄨㄞˋ","ㄗ˙"], m:"雙", mz:"ㄕㄨㄤ"},
      {emo:"👖", n:["褲","子"], nz:["ㄎㄨˋ","ㄗ˙"], m:"條", mz:"ㄊㄧㄠˊ"},
      {emo:"👗", n:["裙","子"], nz:["ㄑㄩㄣˊ","ㄗ˙"], m:"件", mz:"ㄐㄧㄢˋ"},
      {emo:"👕", n:["衣","服"], nz:["ㄧ","ㄈㄨˊ"], m:"件", mz:"ㄐㄧㄢˋ"},
      {emo:"🧢", n:["帽","子"], nz:["ㄇㄠˋ","ㄗ˙"], m:"頂", mz:"ㄉㄧㄥˇ"},
      {emo:"🧤", n:["手","套"], nz:["ㄕㄡˇ","ㄊㄠˋ"], m:"副", mz:"ㄈㄨˋ"},
      {emo:"👓", n:["眼","鏡"], nz:["ㄧㄢˇ","ㄐㄧㄥˋ"], m:"副", mz:"ㄈㄨˋ"},
      {emo:"🗺️", n:["地","圖"], nz:["ㄉㄧˋ","ㄊㄨˊ"], m:"張", mz:"ㄓㄤ"},
      {emo:"🖼️", n:["相","片"], nz:["ㄒㄧㄤˋ","ㄆㄧㄢˋ"], m:"張", mz:"ㄓㄤ"},
      {emo:"🎫", n:["票"], nz:["ㄆㄧㄠˋ"], m:"張", mz:"ㄓㄤ"},
      {emo:"📄", n:["紙"], nz:["ㄓˇ"], m:"張", mz:"ㄓㄤ"},
      {emo:"🍪", n:["餅","乾"], nz:["ㄅㄧㄥˇ","ㄍㄢ"], m:"片", mz:"ㄆㄧㄢˋ"},
      {emo:"🎂", n:["蛋","糕"], nz:["ㄉㄢˋ","ㄍㄠ"], m:"塊", mz:"ㄎㄨㄞˋ"},
      {emo:"🥯", n:["麵","包"], nz:["ㄇㄧㄢˋ","ㄅㄠ"], m:"個", mz:"ㄍㄜˋ"},
      {emo:"🍉", n:["西","瓜"], nz:["ㄒㄧ","ㄍㄨㄚ"], m:"顆", mz:"ㄎㄜ"},
      {emo:"🌸", n:["花"], nz:["ㄏㄨㄚ"], m:"朵", mz:"ㄉㄨㄛˇ"},
      {emo:"🌳", n:["樹"], nz:["ㄕㄨˋ"], m:"棵", mz:"ㄎㄜ"},
      {emo:"⛰️", n:["山"], nz:["ㄕㄢ"], m:"座", mz:"ㄗㄨㄛˋ"},
      {emo:"🏠", n:["房","子"], nz:["ㄈㄤˊ","ㄗ˙"], m:"棟", mz:"ㄉㄨㄥˋ"},
      {emo:"🌉", n:["橋"], nz:["ㄑㄧㄠˊ"], m:"座", mz:"ㄗㄨㄛˋ"},
      {emo:"🏞️", n:["河"], nz:["ㄏㄜˊ"], m:"條", mz:"ㄊㄧㄠˊ"},
      {emo:"🛤️", n:["路"], nz:["ㄌㄨˋ"], m:"條", mz:"ㄊㄧㄠˊ"},
      {emo:"☁️", n:["雲"], nz:["ㄩㄣˊ"], m:"朵", mz:"ㄉㄨㄛˇ"},
      {emo:"⭐", n:["星","星"], nz:["ㄒㄧㄥ","ㄒㄧㄥ"], m:"顆", mz:"ㄎㄜ"},
      {emo:"🌞", n:["太","陽"], nz:["ㄊㄞˋ","ㄧㄤˊ"], m:"顆", mz:"ㄎㄜ"},
      {emo:"🌕", n:["月","亮"], nz:["ㄩㄝˋ","ㄌㄧㄤˋ"], m:"輪", mz:"ㄌㄨㄣˊ"},
      {emo:"🪥", n:["牙","刷"], nz:["ㄧㄚˊ","ㄕㄨㄚ"], m:"支", mz:"ㄓ"},
      {emo:"💡", n:["燈","泡"], nz:["ㄉㄥ","ㄆㄠˋ"], m:"顆", mz:"ㄎㄜ"},
      {emo:"🗝️", n:["鑰","匙"], nz:["ㄧㄠˋ","ㄕ˙"], m:"把", mz:"ㄅㄚˇ"},
      {emo:"🚪", n:["門"], nz:["ㄇㄣˊ"], m:"扇", mz:"ㄕㄢˋ"},
      {emo:"🪟", n:["窗","戶"], nz:["ㄔㄨㄤ","ㄏㄨˋ"], m:"扇", mz:"ㄕㄢˋ"}
    ];

    // 狀態
    let score = 0;
    let streak = 0;
    let current = null;
    let usedIndex = -1;
    let lock = false; // 防連點
    let audioLock = false; // 防止音效播放中被打斷
    let showEmoji = true; // 控制 emoji 顯示狀態
    let showZhuyin = true; // 控制注音顯示狀態
    let autoNextTimer = null; // 自動跳題計時器
    
    // 音頻上下文（全域共用，避免重複創建）
    let audioContext = null;
    
    // 初始化音頻上下文
    function initAudioContext() {
      if (!audioContext) {
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.warn('Audio context creation failed:', e);
        }
      }
      return audioContext;
    }

    // 鼓勵話語陣列
    const ENCOURAGE_MESSAGES = [
      "🌈 一起來學量詞吧！",
      "⭐ 你是最棒的！",
      "🦋 慢慢來，我們一定會學得會！",
      "🌸 今天要開心學習喔！",
      "🐻 相信自己，你很聰明！",
      "🎈 這次要答對幾題？",
      "🌺 這次挑戰成功有什麼獎勵？",
      "🌟 等一下會厲害的嚇到我嗎！",
      "🦄 這次要變得更厲害！",
      "🎀 加油！我們可以做得很好！"
    ];

    // DOM
    const scoreEl = document.getElementById('score');
    const streakEl = document.getElementById('streak');
    const emojiEl = document.getElementById('emoji');
    const nounEl  = document.getElementById('noun');
    const optsEl  = document.getElementById('options');
    const feedbackEl = document.getElementById('feedback');
    const startBtn = document.getElementById('startBtn');
    const nextBtn  = document.getElementById('nextBtn');
    const resetBtn = document.getElementById('resetBtn');
    const toggleEmojiBtn = document.getElementById('toggleEmojiBtn');
    const toggleZyBtn = document.getElementById('toggleZyBtn');
    const promptEl = document.querySelector('.prompt');
    const welcomeMessageEl = document.getElementById('welcomeMessage');
    const encourageTextEl = document.getElementById('encourageText');

    // Web Audio API：答對/答錯旋律
    function beep(ok=true){
      if(audioLock) return; // 防止音效重疊
      
      const ctx = initAudioContext();
      if (!ctx) return; // 如果音頻上下文創建失敗，靜默返回
      
      // 確保音頻上下文處於運行狀態
      if (ctx.state === 'suspended') {
        ctx.resume().catch(e => console.warn('Audio context resume failed:', e));
      }
      
      audioLock = true;
      let totalDuration = 0;
      
      try {
        if(ok){
          // 答對旋律：Do-Mi-Sol 上行音階 (C-E-G)
          const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
          notes.forEach((freq, i) => {
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.type = 'triangle';
            o.frequency.value = freq;
            o.connect(g);
            g.connect(ctx.destination);
            
            const startTime = ctx.currentTime + i * 0.15;
            g.gain.setValueAtTime(0.001, startTime);
            g.gain.exponentialRampToValueAtTime(0.23, startTime + 0.03);
            g.gain.exponentialRampToValueAtTime(0.001, startTime + 0.12);
            
            o.start(startTime);
            o.stop(startTime + 0.12);
          });
          totalDuration = 3 * 0.15; // 0.45秒
        } else {
          // 答錯旋律：Sol-Mi-Do 下行音階 (G-E-C)
          const notes = [783.99, 659.25, 523.25]; // G5, E5, C5
          notes.forEach((freq, i) => {
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.type = 'sawtooth';
            o.frequency.value = freq;
            o.connect(g);
            g.connect(ctx.destination);
            
            const startTime = ctx.currentTime + i * 0.18;
            g.gain.setValueAtTime(0.001, startTime);
            g.gain.exponentialRampToValueAtTime(0.12, startTime + 0.02);
            g.gain.exponentialRampToValueAtTime(0.001, startTime + 0.15);
            
            o.start(startTime);
            o.stop(startTime + 0.15);
          });
          totalDuration = 3 * 0.18; // 0.54秒
        }
        
        // 音效播放完成後解除鎖定
        setTimeout(() => {
          audioLock = false;
        }, (totalDuration + 0.1) * 1000); // 多加0.1秒緩衝
        
      } catch (e) {
        console.warn('Audio playback failed:', e);
        audioLock = false; // 發生錯誤時立即解除鎖定
      }
    }

    // 工具：隨機整數
    const rnd = (n)=> Math.floor(Math.random()*n);

    // 工具：從 MEASURES 取不同的干擾選項
    function pickDistractors(correct, count=3){
      const pool = MEASURES.filter(m=>m.han!==correct.han);
      const out = [];
      while(out.length<count && pool.length){
        const i = rnd(pool.length);
        out.push(pool.splice(i,1)[0]);
      }
      return out;
    }

    // 切換 emoji 顯示/隱藏
    function toggleEmoji() {
      showEmoji = !showEmoji;
      
      if (showEmoji) {
        emojiEl.classList.remove('hidden-content');
        toggleEmojiBtn.classList.remove('active');
      } else {
        emojiEl.classList.add('hidden-content');
        toggleEmojiBtn.classList.add('active');
      }
    }

    // 切換注音顯示/隱藏
    function toggleZhuyin() {
      showZhuyin = !showZhuyin;
      
      if (showZhuyin) {
        toggleZyBtn.classList.remove('active');
        // 顯示所有注音
        document.querySelectorAll('idiv').forEach(idiv => {
          idiv.dataset.after = idiv.dataset.after2;
        });
      } else {
        toggleZyBtn.classList.add('active');
        // 隱藏所有注音
        document.querySelectorAll('idiv').forEach(idiv => {
          idiv.dataset.after2 = idiv.dataset.after;
          idiv.dataset.after = '';
        });
      }
    }

    // 題面渲染（含注音 ruby）
    function renderPrompt(q){
      emojiEl.textContent = q.emo;
      
      // 將陣列格式的中文字與注音組合成 ruby 標籤
      const rubyPairs = q.n.map((char, index) => `
<idiv data-after="${showZhuyin ? q.nz[index] : ''}" data-after2="${showZhuyin ? '' : q.nz[index]}">${char}</idiv>
      `);
      nounEl.innerHTML = rubyPairs.join('');
      
      // 根據當前狀態設置 emoji 顯示
      if (!showEmoji) {
        emojiEl.classList.add('hidden-content');
      } else {
        emojiEl.classList.remove('hidden-content');
      }
    }

    // 產生一題
    function newQuestion(){
      // 清除任何正在進行的自動跳題計時器
      if (autoNextTimer) {
        clearTimeout(autoNextTimer);
        autoNextTimer = null;
      }
      
      // 如果音效正在播放，等待一小段時間再執行
      if(audioLock) {
        setTimeout(() => newQuestion(), 100);
        return;
      }
      
      lock = false;
      feedbackEl.textContent = '';
      feedbackEl.className = 'feedback';

      // 避免連續同題
      let idx;
      do{ idx = rnd(DATA.length); }while(idx===usedIndex && DATA.length>1);
      usedIndex = idx;
      current = DATA[idx];

      renderPrompt(current);

      // 正解量詞物件
      const correct = {han:current.m, zy:current.mz};

      // 生成選項（正解 + 3 干擾），並洗牌
      const options = [correct, ...pickDistractors(correct,3)]
        .sort(()=>Math.random()-0.5);

      // 繪製按鈕（量詞＋注音）
      optsEl.innerHTML = '';
      options.forEach(op=>{
        const btn = document.createElement('button');
        btn.className = 'opt';
        btn.innerHTML = `
<div style="margin: 0 auto;" class="dummy2 tb v after">
  <div class="ansBtn">
    <idiv data-after="${showZhuyin ? op.zy : ''}" data-after2="${showZhuyin ? '' : op.zy}">${op.han}</idiv>
  </div>
</div>
`;
        btn.onclick = ()=> choose(op, correct, btn);
        optsEl.appendChild(btn);
      });
    }

    // 作答
    function choose(sel, correct, btn){
      if(lock) return;
      lock = true;

      // 清除任何正在進行的自動跳題計時器
      if (autoNextTimer) {
        clearTimeout(autoNextTimer);
        autoNextTimer = null;
      }

      const isOk = sel.han===correct.han;
      if(isOk){
        score++; streak++;
        scoreEl.textContent = score;
        streakEl.textContent = streak;
        feedbackEl.textContent = '太棒了！答對了👏';
        feedbackEl.className = 'feedback ok';
        btn.classList.add('correct');
        beep(true);
        // 答對時1.3秒後自動下一題，使用計時器變數追蹤
        autoNextTimer = setTimeout(()=>{
          autoNextTimer = null;
          newQuestion();
        }, 1300);
      }else{
        streak = 0;
        streakEl.textContent = streak;
        feedbackEl.innerHTML = `
  再想想～正確量詞是：
  <span class="dummy2 tb v after">
    <span style="font-size: 26px;">
      <idiv data-after="${showZhuyin ? correct.zy : ''}" data-after2="${showZhuyin ? '' : correct.zy}">${correct.han}</idiv>
    </span>
  </span>
        `;
        feedbackEl.className = 'feedback no';
        btn.classList.add('wrong');
        // 高亮正解
        [...optsEl.children].forEach(b=>{
          if(b.textContent.trim().includes(correct.han)) b.classList.add('correct');
        });
        beep(false);
        // 答錯時不自動跳題，需手動按下一題
      }
    }

    // 隨機選擇鼓勵話語
    function setRandomEncourageMessage() {
      const randomIndex = rnd(ENCOURAGE_MESSAGES.length);
      encourageTextEl.textContent = ENCOURAGE_MESSAGES[randomIndex];
    }

    // 事件：開始／下一題／重置
    startBtn.onclick = ()=>{
      // 初始化音頻上下文（需要用戶互動才能啟動）
      initAudioContext();
      
      score = 0; streak = 0;
      scoreEl.textContent = score;
      streakEl.textContent = streak;
      
      // 隱藏歡迎訊息，顯示提示區塊
      welcomeMessageEl.classList.add('hidden');
      promptEl.classList.remove('hidden');
      
      // 隱藏開始按鈕，顯示其他控制按鈕
      startBtn.classList.add('hidden');
      nextBtn.classList.remove('hidden');
      toggleEmojiBtn.classList.remove('hidden');
      toggleZyBtn.classList.remove('hidden');
      resetBtn.classList.remove('hidden');
      
      newQuestion();
    };
    nextBtn.onclick = ()=> {
      // 清除自動跳題計時器（如果存在）
      if (autoNextTimer) {
        clearTimeout(autoNextTimer);
        autoNextTimer = null;
      }
      newQuestion();
    };
    toggleEmojiBtn.onclick = toggleEmoji;
    toggleZyBtn.onclick = toggleZhuyin;
    resetBtn.onclick = ()=>{
      // 清除自動跳題計時器
      if (autoNextTimer) {
        clearTimeout(autoNextTimer);
        autoNextTimer = null;
      }
      
      // 如果音效正在播放，強制停止
      if(audioLock) {
        audioLock = false;
        if (audioContext && audioContext.state === 'running') {
          // 停止所有正在進行的音頻節點
          try {
            audioContext.suspend();
          } catch (e) {
            console.warn('Failed to suspend audio context:', e);
          }
        }
      }
      
      score = 0; streak = 0;
      scoreEl.textContent = score;
      streakEl.textContent = streak;
      feedbackEl.textContent = '';
      feedbackEl.className = 'feedback';
      lock = false; // 重置鎖定狀態
      
      // 顯示歡迎訊息，隱藏提示區塊
      welcomeMessageEl.classList.remove('hidden');
      promptEl.classList.add('hidden');
      
      // 重新隨機選擇鼓勵話語
      setRandomEncourageMessage();
      
      // 重置按鈕顯示狀態
      startBtn.classList.remove('hidden');
      nextBtn.classList.add('hidden');
      toggleEmojiBtn.classList.add('hidden');
      toggleZyBtn.classList.add('hidden');
      resetBtn.classList.add('hidden');
      
      // 重置提示顯示狀態
      showEmoji = true;
      showZhuyin = true;
      toggleEmojiBtn.classList.remove('active');
      toggleZyBtn.classList.remove('active');
      
      // 清空題目顯示
      emojiEl.textContent = '';
      emojiEl.classList.remove('hidden-content');
      nounEl.innerHTML = '';
      optsEl.innerHTML = '';
    };

    // 初次載入：設定隨機鼓勵話語
    setRandomEncourageMessage();
  </script>
</body>
</html>
